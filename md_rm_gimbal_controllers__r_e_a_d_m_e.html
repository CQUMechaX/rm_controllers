<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>rm_controllers: rm_gimbal_controllers</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">rm_controllers
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title"><a class="el" href="namespacerm__gimbal__controllers.html">rm_gimbal_controllers</a> </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md39"></a>
Overview</h1>
<p>The <a class="el" href="namespacerm__gimbal__controllers.html">rm_gimbal_controllers</a> has three states: RATE, TRACK, and DIRECT. It performs PID control on the yaw joint and pitch joint according to commands. It can also perform moving average filtering based on detection data and calculate, predict and track targets based on the ballistic model.</p>
<p><b>Keywords:</b> ROS, Robomaster, gimbal, bullet solver, moving average filter</p>
<h2><a class="anchor" id="autotoc_md40"></a>
License</h2>
<p>The source code is released under a <a href="https://github.com/rm-controls/rm_controllers/blob/master/LICENSE">BSD 3-Clause license</a>.</p>
<p><b>Author: DynamicX<br  />
 Affiliation: DynamicX<br  />
 Maintainer: DynamicX</b></p>
<p>The package has been tested under <a href="https://www.ros.org/">ROS</a> Indigo, Melodic and Noetic on respectively Ubuntu 18.04 and 20.04. This is research code, expect that it changes often and any fitness for a particular purpose is disclaimed.</p>
<h2><a class="anchor" id="autotoc_md41"></a>
Hardware interface type</h2>
<ul>
<li><code>JointStateInterface</code> Used to get the speed and position of gimbal joint.</li>
<li><code>EffortJointInterface</code> Used to send effort command to gimbal joint .</li>
<li><code>RoboStateInterface</code> Used to get the current and historical transform between gimbal and the world coordinate system and the transform between visual target and the world coordinate system.</li>
</ul>
<h1><a class="anchor" id="autotoc_md42"></a>
Installation</h1>
<h2><a class="anchor" id="autotoc_md43"></a>
Installation from Packages</h2>
<p>To install all packages from the this repository as Debian packages use </p><pre class="fragment">sudo apt-get install ros-noetic-rm-gimbal-controllers
</pre><p> Or better, use <code>rosdep</code>: </p><pre class="fragment">sudo rosdep install --from-paths src
</pre> <h2><a class="anchor" id="autotoc_md44"></a>
Building from Source</h2>
<h3><a class="anchor" id="autotoc_md45"></a>
Dependencies</h3>
<ul>
<li>roscpp</li>
<li>roslint</li>
<li>rm_msgs</li>
<li>rm_common</li>
<li>pluginlib</li>
<li>hardware_interface</li>
<li>controller_interface</li>
<li>forward_command_controller</li>
<li>realtime_tools</li>
<li>control_toolbox</li>
<li>effort_controllers</li>
<li>tf2</li>
<li>tf2_geometry_msgs</li>
<li>angles</li>
<li>visualization_msgs</li>
<li>dynamic_reconfigure</li>
</ul>
<h3><a class="anchor" id="autotoc_md46"></a>
Building</h3>
<p>To build from source, clone the latest version from this repository into your catkin workspace and compile the package using </p><pre class="fragment">cd catkin_workspace/src
git clone https://github.com/rm-controls/rm_controllers.git
cd ../
rosdep install --from-paths . --ignore-src
catkin build
</pre><h1><a class="anchor" id="autotoc_md47"></a>
Usage</h1>
<p>Run the controller with mon launch: </p><pre class="fragment">  mon launch rm_gimbal_controller load_controllers.launch
</pre> <h1><a class="anchor" id="autotoc_md48"></a>
Launch files</h1>
<ul>
<li><b>load_controllers.launch</b>: Load the parameters in config files and load tf and <a class="el" href="namespacerobot__state__controller.html">robot_state_controller</a>, joint_state_controller, gimbal_controller.</li>
</ul>
<h1><a class="anchor" id="autotoc_md49"></a>
ROS API</h1>
<h3><a class="anchor" id="autotoc_md50"></a>
Subscribed Topics</h3>
<ul>
<li><p class="startli">**<code>command</code>** (rm_msgs/GimbalCmd)</p>
<p class="startli">Set gimbal mode, pitch and yaw axis rotation speed, tracking target, pointing target and coordinate system.</p>
</li>
<li><p class="startli">**<code>/detection</code>** (rm_msgs/TargetDetectionArray)</p>
<p class="startli">Receive visual recognition data.</p>
</li>
<li><p class="startli">**<code>/&lt;camera_name&gt;/camera_info</code>** (CameraInfo)</p>
<p class="startli">Make sure that the detection node receives a new frame of image and sends the prediction data to the detection node.</p>
</li>
</ul>
<h3><a class="anchor" id="autotoc_md51"></a>
Published Topics</h3>
<ul>
<li>**<code>error</code>** (rm_msgs/GimbalDesError) The error calculated by the ballistic model to shoot at the current gimbal angle to the target.</li>
<li>**<code>track</code>** (rm_msgs/TrackDataArray) The predicted data used for detection node to decide the ROI. </li>
</ul>
<h4><a class="anchor" id="autotoc_md52"></a>
Bullet solver</h4>
<ul>
<li>**<code>model_desire</code>** ( <a href="http://docs.ros.org/en/api/visualization_msgs/html/msg/Marker.html">visualization_msgs/Marker</a> ) Used to visualize the desired bullet trajectory.</li>
<li>**<code>model_real</code>** ( <a href="http://docs.ros.org/en/api/visualization_msgs/html/msg/Marker.html">visualization_msgs/Marker</a> ) Used to visualize the trajectory that caculated by ballistic model in the current gimbal angle. </li>
</ul>
<h3><a class="anchor" id="autotoc_md53"></a>
Parameters</h3>
<ul>
<li><p class="startli">**<code>detection_topic</code>** (string, default: "/detection")</p>
<p class="startli">The name of the topic where detection node gets predicted data.</p>
</li>
<li><p class="startli">**<code>detection_frame</code>** (string, default: "detection")</p>
<p class="startli">The name of the frame of detection.</p>
</li>
<li><p class="startli">**<code>camera_topic</code>** (string, default: "/galaxy_camera/camera_info")</p>
<p class="startli">The name of the topic that is determined that the detection node receives a new frame of image and sends the prediction data to the detection node.</p>
</li>
<li><p class="startli">**<code>publish_rate</code>** (double)</p>
<p class="startli">Frequency (in Hz) of publishing gimbal error.</p>
</li>
<li><p class="startli">**<code>chassis_angular_data_num</code>** (double)</p>
<p class="startli">The number of angle data of chassis.Used for chassis angular average filter.</p>
</li>
<li><p class="startli">**<code>time_compensation</code>** (double)</p>
<p class="startli">Time(in s) of image transmission delay(in s).Used to compensate for the effects of images transimission delay</p>
</li>
</ul>
<h4><a class="anchor" id="autotoc_md54"></a>
Bullet solver</h4>
<p><em>Bullet solver is used to get the bullet drop point</em></p><ul>
<li><p class="startli">**<code>resistance_coff_qd_10, resistance_coff_qd_15, resistance_coff_qd_16, resistance_coff_qd_18, resistance_coff_qd_30</code>** ( <code>double</code> )</p>
<p class="startli">The air resistance coefficient used for bullet solver when bullet speed is 10 m/s, 15 m/s, 16 m/s, 18 m/s and 30 m/s.</p>
</li>
<li><p class="startli">**<code>g</code>** (double)</p>
<p class="startli">Acceleration of gravity.</p>
</li>
<li><p class="startli">**<code>delay</code>** (double)</p>
<p class="startli">Shooting delay time(in s) after shooter get the shooting command.Used to compensate for the effects of launch delay.</p>
</li>
<li><p class="startli">**<code>timeout</code>** (double)</p>
<p class="startli">Timeout time((in s)) of bullet solver.Used to judge whether bullet solver can caculate the bullet drop point.</p>
</li>
</ul>
<h4><a class="anchor" id="autotoc_md55"></a>
Moving average filter</h4>
<p><em>Moving average filter is used for filter the target armor center when target is spin.</em></p><ul>
<li><p class="startli">**<code>is_debug</code>** ( <code>bool</code>, default: true )</p>
<p class="startli">The debug status.When it is true, debug data will be pulished on the filter topic.</p>
</li>
<li><p class="startli">**<code>pos_data_num</code>** (double, default: 20)</p>
<p class="startli">The number of armor position data.</p>
</li>
<li><p class="startli">**<code>vel_data_num</code>** (double, default: 30)</p>
<p class="startli">The number of armor linear velocity data.</p>
</li>
<li><p class="startli">**<code>gyro_data_num</code>** (double, default: 100)</p>
<p class="startli">The number of target rotation speed data.</p>
</li>
<li><p class="startli">**<code>center_data_num</code>** (double, default: 50)</p>
<p class="startli">The number of target rotation center position data.</p>
</li>
<li><p class="startli">**<code>center_offset_z</code>** (double)</p>
<p class="startli">Offset(in meter) on the z axis.Used to compensate for the error of filter result on z axis.</p>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md56"></a>
Controller configuration examples</h1>
<div class="fragment"><div class="line">gimbal_controller:</div>
<div class="line">    type: rm_gimbal_controllers/Controller</div>
<div class="line">    time_compensation: 0.03</div>
<div class="line">    publish_rate: 100</div>
<div class="line">    chassis_angular_data_num: 20</div>
<div class="line">    camera_topic: &quot;/galaxy_camera/camera_info&quot;</div>
<div class="line">    yaw:</div>
<div class="line">      joint: &quot;yaw_joint&quot;</div>
<div class="line">      pid: { p: 8, i: 0, d: 0.4, i_clamp_max: 0.0, i_clamp_min: -0.0, antiwindup: true, publish_state: true }</div>
<div class="line">    pitch:</div>
<div class="line">      joint: &quot;pitch_joint&quot;</div>
<div class="line">      pid: { p: 10, i: 50, d: 0.3, i_clamp_max: 0.4, i_clamp_min: -0.4, antiwindup: true, publish_state: true }</div>
<div class="line">    bullet_solver:</div>
<div class="line">      resistance_coff_qd_10: 0.45</div>
<div class="line">      resistance_coff_qd_15: 0.1</div>
<div class="line">      resistance_coff_qd_16: 0.7</div>
<div class="line">      resistance_coff_qd_18: 0.55</div>
<div class="line">      resistance_coff_qd_30: 3.0</div>
<div class="line">      g: 9.81</div>
<div class="line">      delay: 0.1</div>
<div class="line">      dt: 0.001</div>
<div class="line">      timeout: 0.001</div>
<div class="line">      publish_rate: 50</div>
<div class="line">    moving_average_filter:</div>
<div class="line">      is_debug: true</div>
<div class="line">      center_offset_z: 0.05</div>
<div class="line">      pos_data_num: 20</div>
<div class="line">      vel_data_num: 30</div>
<div class="line">      center_data_num: 50</div>
<div class="line">      gyro_data_num: 100</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md57"></a>
Bugs &amp; Feature Requests</h1>
<p>Please report bugs and request features using the <a href="https://github.com/rm-controls/rm_controllers/issues">Issue Tracker</a>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
